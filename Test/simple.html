<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script type=module src="OtoReact.js"></script>
    </head>
    <body hidden type=rhtml>
      <!-- Styles are global; we must use a class to restrict these rules to the current demo -->
<style>
  div.tic-tac-toe {
      display:grid;
      grid-template-columns: auto 120pt;
      background-color: white;
  }
  .tic-tac-toe table {
      width: fit-content;
      margin:1ex
  }
  .tic-tac-toe td {
      height: 4ex; width: 4ex;
      padding: 0px;
      border: 2px solid;
      line-height: 1;
      text-align: center;
      vertical-align: middle;
  }
  .tic-tac-toe button {
      font-size: 80%;
  }
</style>

<!-- By using a local script, multiple instances of this game will have their own state -->
<script type="otoreact/local" 
defines="board,toMove,outcome,ClearAll,Move,CheckWinner"
>
  let
    board =    RVAR(),           // State of the board
    toMove =   RVAR(null, 'X'), // Player to move: 'O' or 'X'
    outcome =  RVAR(),    // Player that has won, or boolean true when it's a draw
    count = 0;            // Number of moves made

  function ClearAll() {
      // Initialize the board as an array of arrays of objects {P: 'O' | 'X'}
      board.V = Board();
      // Reset the outcome
      outcome.V = null;
      count = 0;
      
      function Cell() {return {P: null}; }
      function Row()  {return [Cell(), Cell(), Cell()]; }
      function Board(){return [Row(), Row(), Row()]; }
  }

  ClearAll();

  function Move(cell) {
      // Play a move, when allowed
      if (outcome.V || cell.P) // Move not allowed
        return;
      cell.U.P = toMove.V; // Update the cell
      toMove.V = (toMove.V=='X' ? 'O' : 'X'); // Set next player to move
      count++;   // Count moves
      outcome.V = CheckWinner(board.V) || count==9; // Check end of game
  }

  function CheckWinner(b) {
      // Check if there is a winner
      let w = null;
      for (let i=0;i<3;i++) {
          w = w || CheckRow(...b[i]);   // Horizontal row
          w = w || CheckRow(b[0][i], b[1][i], b[2][i]); // Vertical row
      }
      for (let i=-1;i<=1;i+=2)
          w = w || CheckRow(b[0][1+i], b[1][1], b[2][1-i]); // Diagonal row
      return w;

      function CheckRow(c1, c2, c3) {
          // Return the result when the three cells have the same state
          return (c1.P == c2.P && c2.P == c3.P && c1.P);
      }
}
</script>

<div class=tic-tac-toe>
<!-- Caption -->
<div style="grid-column: 1/3; text-align: center;">
  <b>Tic-Tac-Toe</b>
</div>

<!-- Show the board -->
<table. reacton=board>
        <!-- This table should react on the RVAR 'board'. -->
  <for let=row of="board.V">
    <tr.>
      <for let=cell of="row" reacting>
        <td. onclick="Move(cell)"
         >{cell.P}</td.>
      </for>
    </tr.>
  </for>
</table.>
<!-- Show either the outcome, or the player to move -->
<div>
  <p reacton=outcome,toMove>
    <case>
      <when cond="outcome.V===true">
        <b>It's a draw.</b>
      </when>
      <when cond="outcome.V">
        <b>The winner is: <large>{outcome.V}</large></b>
      </when>
      <else>
        Player to move: {toMove.V}
      </else>
    </case>
  </p>
  <button onclick="ClearAll()">Clear</button>
</div>
</div>

    </body>
</html>